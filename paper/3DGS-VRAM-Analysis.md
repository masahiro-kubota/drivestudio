# 3D Gaussian Splatting トレーニング時のVRAM使用量分析

## 📊 エグゼクティブサマリー

### Deformable 3D Gaussians
- **推定VRAM**: 1-2 GB（250kガウシアン）
- **使用GPU**: NVIDIA RTX 3090
- **ボトルネック**: ガウシアン数（250k未満でリアルタイムレンダリング可能）

### OmniRe
- **推定VRAM**: 3-5 GB（複雑なシーン、1.38Mガウシアン）
- **使用GPU**: NVIDIA RTX 4090
- **ボトルネック**: ガウシアン数 + 複数の動的オブジェクト

---

## 1. VRAM使用量の主要決定要因

### 1.1 3D Gaussiansの数（最重要）

#### メモリ計算

**各ガウシアンのパラメータサイズ**:
```
- 位置 μ (3D座標):        3 × 4 bytes = 12 bytes
- 不透明度 o:             1 × 4 bytes = 4 bytes
- 回転 q (四元数):        4 × 4 bytes = 16 bytes
- スケーリング s:         3 × 4 bytes = 12 bytes
- SH係数 c (次数3):      48 × 4 bytes = 192 bytes
─────────────────────────────────────────────
合計:                                  236 bytes/ガウシアン
```

**スケールごとの推定メモリ**:
| ガウシアン数 | ベースメモリ | 推定総VRAM* |
|-------------|-------------|-------------|
| 100k        | 23.6 MB     | 0.5-1 GB    |
| 250k        | 59 MB       | 1-2 GB      |
| 500k        | 118 MB      | 2-3 GB      |
| 1,000k      | 236 MB      | 3-5 GB      |
| 1,500k      | 354 MB      | 5-7 GB      |

\* 勾配、最適化状態、中間バッファ含む（5-10倍の係数）

#### 論文での実測値

**Deformable 3D Gaussians**:
> "3D Gaussians数が250k未満の場合、30 FPS以上のリアルタイムレンダリングを達成可能（NVIDIA RTX 3090）"

- **臨界点**: ~250k ガウシアン
- これを超えると急激にメモリ消費とトレーニング時間が増加

**OmniRe**:
> "背景モデル初期化: LiDARポイント 6×10⁵ + ランダムサンプル 4×10⁵ = 合計 1,000,000ポイント"

複雑なシーンの例:
```
- 背景:           1,000,000 ガウシアン
- 車両10台:         300,000 ガウシアン (各30k)
- 歩行者5人:         50,000 ガウシアン (各10k)
- その他3個体:       30,000 ガウシアン (各10k)
─────────────────────────────────────────
合計:             1,380,000 ガウシアン
```

---

### 1.2 画像解像度

**Deformable 3D Gaussians**:
- **トレーニング解像度**: 800×800（合成データセット）
- フル解像度で処理

**OmniRe**:
- **トレーニング解像度**: 640×960（3台のカメラ）
- すべてのベースライン手法で統一

**解像度の影響**:
- ラスタライゼーション時の中間バッファサイズに影響
- 高解像度ほどVRAM消費増加（ただし、ガウシアン数ほど支配的ではない）

---

### 1.3 球面調和関数（SH）の次数

**次数ごとのSH係数数**:
| 次数 | 係数数 | メモリ/ガウシアン | 対ベースライン |
|-----|-------|----------------|--------------|
| 0   | 1     | 3×1×4 = 12 B   | 100%         |
| 1   | 4     | 3×4×4 = 48 B   | 400%         |
| 2   | 9     | 3×9×4 = 108 B  | 900%         |
| 3   | 16    | 3×16×4 = 192 B | 1600%        |

**OmniReの戦略的使用**:
```
- 背景ノード:               次数 3 (高品質)
- 剛体ノード（車両）:       次数 3 (高品質)
- 非剛体変形可能ノード:     次数 3 (高品質)
- 非剛体SMPLノード（歩行者）: 次数 1 (効率化)
```

**メモリ削減効果**（SMPLノードで次数1使用）:
- 192 B → 48 B（SH係数部分）
- **75%削減**

---

### 1.4 ネットワークアーキテクチャ

#### Deformable 3D Gaussians - 変形フィールドMLP

**構造**:
```
入力: (γ(x), γ(t))
│
├─ 8層の全結合層
│  - 各層: 256次元隠れ層
│  - 活性化: ReLU
│  - 4層目で入力を再連結（NeRF風）
│
└─ 出力: 256次元特徴ベクトル
   │
   └─ 3つの全結合層（活性化なし）
      ├─ 位置オフセット δx
      ├─ 回転オフセット δr
      └─ スケーリングオフセット δs
```

**パラメータ数推定**:
- 入力層: (入力次元×256) + 256
- 隠れ層×7: (256×256 + 256) × 7
- 出力層×3: (256×3 + 3) × 3

**メモリ**:
> "3D Gaussiansに対して追加ストレージ **わずか2MB**"

**重要な洞察**:
変形ネットワークのメモリは、ガウシアン本体に比べて **無視できるレベル**

#### OmniRe - 共有変形ネットワーク

**戦略**:
- **単一の変形ネットワーク重み φ を全ノードで共有**
- インスタンス埋め込み e_h でノードを識別
- ノード数が増えても **ネットワーク重み自体は増加しない**

**メモリ効率化**:
- 従来手法（Yang et al., 2023c）: シーン全体に単一ネットワーク → 複雑なシーンで失敗
- OmniRe: ノードごとの変形フィールド + 重み共有 → **表現力とメモリ効率を両立**

**推定メモリ**: 5-10 MB（Deformableより若干大きいが依然として小さい）

---

### 1.5 その他のメモリ消費要因

#### a) 勾配とオプティマイザ状態

**Adam Optimizer**（両手法で使用）:
- 各パラメータに対して:
  - 勾配: 1×パラメータサイズ
  - 1次モーメント（m）: 1×パラメータサイズ
  - 2次モーメント（v）: 1×パラメータサイズ

**合計**: パラメータの **3倍**のメモリ

#### b) 中間バッファ

- ラスタライゼーション中間結果
- ソート用バッファ
- タイル処理用バッファ

**推定**: パラメータの **2-5倍**のメモリ

#### c) SMPLスキニング重み（OmniReのみ）

**LBS（Linear Blend Skinning）重み**:
```
W ∈ ℝ^(n_v × n_k)
- n_v: 頂点数（約6,890）
- n_k: 関節数（24）

メモリ: 6,890 × 24 × 4 bytes ≈ 0.66 MB/人
```

歩行者5人の場合: 約3.3 MB（比較的小さい）

---

## 2. メモリ最適化・削減手法

### 2.1 Adaptive Density Control（適応的密度制御）

#### Deformable 3D Gaussians

**Pruning（枝刈り）**:
- **対象**: 不透明度が低い透明なガウシアン
- **効果**: 不要なガウシアンを削除してメモリ削減

**Densification（高密度化）**:
- **しきい値**: t_pos = 0.0002（位置勾配）
- **戦略**:
  1. 細かい幾何的領域: ガウシアンをクローン、勾配方向に移動
  2. 大きく重なる領域: ガウシアンを分割、スケールを ξ=1.6 で除算

**重要性**:
> "適応的密度制御がDesirable outcomesを達成するための重要なコンポーネント"

#### OmniRe

**Absolute Gradient Gaussians**（Ye et al., 2024）:
```
- 位置勾配の高密度化しきい値: 3×10⁻⁴
- スケーリングの高密度化しきい値: 3×10⁻³
- 目的: メモリ使用量の制御
```

**実験結果（Table 11）**:
| 手法 | AbsGrad | PSNR | メモリ状態 |
|------|---------|------|-----------|
| StreetGS | なし | - | 正常 |
| StreetGS | あり | - | 正常 |
| DeformableGS | **なし** | - | **OOM（メモリ不足）** |
| DeformableGS | **あり** | +0.1 | **正常** |
| 3DGS | なし | - | 正常 |
| 3DGS | あり | +0.1 | 正常 |

**結論**:
- **OmniReではAbsGradが必須**（なしではOOM）
- わずかな性能向上（+0.1 PSNR）
- メモリ安定化に大きく貢献

### 2.2 Stop-Gradient操作

**Deformable 3D Gaussians**:
```python
(δx, δr, δs) = F_θ(γ(sg(x)), γ(t))
```

- **sg(·)**: stop-gradient操作
- **効果**:
  - 不要な勾配計算を防ぐ
  - バックプロパゲーション時のメモリ使用量を削減
  - トレーニング速度向上

### 2.3 グリッド/プレーン構造を使用しない

**Deformable 3D Gaussians**:
> "グリッド/プレーン構造は使用しない（動的シーンが低ランク仮定に適さないため）"

**理由**:
- 動的シーンは高ランク（情報量が多い）
- 明示的な構造（グリッド/プレーン）は大量のメモリを消費
- 純粋なMLPで表現することでメモリフットプリントを最小化

### 2.4 Annealing Smooth Training (AST)

**Deformable 3D Gaussians**:
```
Δ = F_θ(γ(sg(x)), γ(t) + X(i))
X(i) = N(0,1) · β · Δt · (1 - i/τ)
```

**メモリへの影響**:
> "**追加の計算オーバーヘッドなし**"

- ノイズ注入のみ
- 追加のメモリ確保不要
- トレーニング初期: 汎化向上
- トレーニング後期: ディテール保持

---

## 3. GPU別の推奨設定

### 3.1 8GB VRAM（RTX 3070, RTX 4060 Ti）

**Deformable 3D Gaussians**: ✅ 可能（制限付き）
- ガウシアン数: **150k以下を推奨**
- 解像度: 640×480 または 512×512
- SH次数: 2以下

**OmniRe**: ⚠️ 困難（単純なシーンのみ）
- 背景ガウシアン: **500k以下**
- 動的オブジェクト: 最小限（車両2-3台程度）
- 解像度: 480×640

**推奨設定**:
```yaml
# Deformable 3D Gaussians
max_gaussians: 150000
resolution: [512, 512]
sh_degree: 2
densification_threshold: 0.0005  # 高めに設定
```

### 3.2 12GB VRAM（RTX 3080 Ti, RTX 4070 Ti）

**Deformable 3D Gaussians**: ✅ 快適
- ガウシアン数: **250k程度**（論文の設定）
- 解像度: 800×800（論文通り）
- SH次数: 3

**OmniRe**: ✅ 可能（中程度の複雑さ）
- 背景ガウシアン: **800k程度**
- 動的オブジェクト: 車両5台 + 歩行者2-3人
- 解像度: 640×960（論文通り）
- **Absolute Gradient必須**

**推奨設定**:
```yaml
# OmniRe
background_gaussians: 800000
vehicles: 5
pedestrians: 3
resolution: [640, 960]
use_absgrad: true
sh_degree_smpl: 1  # SMPLノードは低次元化
```

### 3.3 16GB VRAM（RTX 4080）

**Deformable 3D Gaussians**: ✅ 非常に快適
- ガウシアン数: **400k程度**
- 高解像度も可能: 1024×1024
- すべての機能を安全に使用可能

**OmniRe**: ✅ 快適（比較的複雑なシーンも対応）
- 背景ガウシアン: **1,000k（論文通り）**
- 動的オブジェクト: 車両8台 + 歩行者4-5人
- マルチカメラも安全

**推奨設定**: 論文の設定をほぼそのまま使用可能

### 3.4 24GB VRAM（RTX 3090, RTX 4090）

**Deformable 3D Gaussians**: ✅ 完全に快適
- 論文の実験設定を完全に再現可能
- ガウシアン数: **500k以上も可能**

**OmniRe**: ✅ 完全に快適
- 論文の実験設定を完全に再現可能
- **高度に複雑なシーン**でも対応可能
  - 背景: 1,000k
  - 車両: 10台以上
  - 歩行者: 5人以上
  - その他の動的オブジェクト多数

**推奨**: そのまま論文の設定を使用

---

## 4. 実測トレーニング時間とリソース

### 4.1 Deformable 3D Gaussians

**ハードウェア**: NVIDIA RTX 3090

**トレーニング設定**:
```
- 総イテレーション: 40,000
  - 初期3k: 3D Gaussiansのみ
  - その後37k: 3D Gaussians + 変形フィールド共同
- オプティマイザ: Adam
- 解像度: 800×800
```

**時間**: 明記なし（ただし「リアルタイムレンダリング可能」と記載）

**レンダリング速度**:
- **250k未満のガウシアン**: 30+ FPS

### 4.2 OmniRe

**ハードウェア**: NVIDIA RTX 4090

**トレーニング設定**:
```
- 総イテレーション: 30,000
- セグメント長: 約150フレーム
- カメラ: 3台（前面）
- 解像度: 640×960
```

**時間**: **各シーン約1時間**

**注記**: "トレーニング設定により変動"

---

## 5. ベストプラクティス

### 5.1 必須の最適化手法

1. **Absolute Gradient Gaussiansの使用**
   - 特にOmniReでは必須
   - Deformable 3D Gaussiansでも推奨
   - わずかな性能向上（+0.1 PSNR）
   - メモリ安定化に大きく貢献

2. **適応的密度制御の調整**
   - しきい値を適切に設定
   - 不要なガウシアンを定期的にプルーニング
   - 必要な場所に戦略的に高密度化

3. **球面調和関数の次数調整**
   - 重要なオブジェクト（背景、車両）: 次数3
   - 細かいオブジェクト（歩行者など）: 次数1-2
   - メモリ削減と品質のバランス

### 5.2 VRAM不足時の対処法

**段階的な対処法**:

**レベル1（軽度の不足）**:
1. 解像度を下げる: 800×800 → 640×640
2. SH次数を下げる: 3 → 2
3. Densificationしきい値を上げる: 0.0002 → 0.0005

**レベル2（中程度の不足）**:
4. ガウシアンの最大数を制限
5. バッチサイズを削減（該当する場合）
6. 高密度化頻度を下げる

**レベル3（深刻な不足）**:
7. シーンの複雑さを削減（OmniRe）
   - 動的オブジェクト数を減らす
   - シンプルなシーンから開始
8. Mixed Precision Training（FP16）の使用検討
9. Gradient Checkpointing（該当する場合）

### 5.3 パフォーマンスモニタリング

**推奨するメトリクス**:

```python
# 疑似コード
def monitor_memory():
    print(f"ガウシアン数: {num_gaussians}")
    print(f"メモリ使用量: {torch.cuda.memory_allocated() / 1e9:.2f} GB")
    print(f"メモリ最大: {torch.cuda.max_memory_allocated() / 1e9:.2f} GB")
    print(f"予約メモリ: {torch.cuda.memory_reserved() / 1e9:.2f} GB")
```

**警告サイン**:
- メモリ使用量が総VRAMの90%を超える
- 頻繁なOOM（Out of Memory）エラー
- トレーニング速度の著しい低下

---

## 6. 重要な発見とインサイト

### 6.1 ガウシアン数が最大のボトルネック

**データ**:
- 各ガウシアン: 236 bytes（SH次数3）
- 250k ガウシアン: 約59 MB
- しかし、勾配とオプティマイザ状態を含めると **5-10倍**
- **実際のVRAM使用量**: 1-2 GB（250k）

**結論**: ガウシアン数の管理が最も重要

### 6.2 変形ネットワークのメモリは小さい

**Deformable 3D Gaussians**:
- わずか2MB（D=8, W=256のMLP）
- ガウシアン本体に比べて無視できる

**OmniRe**:
- 重み共有により効率化
- ノード数が増えてもネットワーク自体は増加しない

**結論**: ネットワークサイズはメモリの主要な制約ではない

### 6.3 SH次数の戦略的調整が有効

**OmniReの戦略**:
- SMPLノードで次数1 → 75%のSH係数メモリ削減
- 背景・車両では次数3で高品質維持

**一般化**:
- 重要度に応じて次数を調整
- 大きなメモリ削減が可能（次数3→1で75%削減）

### 6.4 メモリ管理戦略の重要性

**Absolute Gradient Gaussians**:
- OmniReでは必須（なしではOOM）
- わずかな性能向上（+0.1 PSNR）
- メモリ安定化に決定的

**適応的密度制御**:
- Pruning: 不要なガウシアンを削除
- Densification: 必要な場所に追加
- 動的なメモリ管理が鍵

### 6.5 データセット規模との関係

**Deformable 3D Gaussians**:
- 比較的小規模（単眼動的シーン）
- RTX 3090で十分

**OmniRe**:
- 大規模（都市シーン、複数の動的オブジェクト）
- RTX 4090が推奨（必須ではない）
- 12GB VRAMでも工夫次第で可能

---

## 7. トラブルシューティング

### 7.1 OOM（Out of Memory）エラー

**症状**:
```
RuntimeError: CUDA out of memory. Tried to allocate X.XX GiB
```

**対処法（優先順）**:

1. **Absolute Gradientを有効化**
   ```python
   use_absgrad = True
   ```

2. **ガウシアン数を制限**
   ```python
   max_num_gaussians = 200000  # 250k → 200k
   ```

3. **解像度を下げる**
   ```python
   resolution = [640, 640]  # 800×800 → 640×640
   ```

4. **SH次数を下げる**
   ```python
   sh_degree = 2  # 3 → 2
   ```

5. **Densificationしきい値を上げる**
   ```python
   densification_threshold = 0.0005  # 0.0002 → 0.0005
   ```

### 7.2 トレーニングが遅い

**症状**:
- イテレーション速度が極端に遅い
- GPUメモリ使用率が高い（90%以上）

**対処法**:

1. **ガウシアン数を確認**
   ```python
   print(f"Current Gaussians: {len(gaussians)}")
   ```

2. **適応的密度制御の頻度を下げる**
   ```python
   densification_interval = 500  # 100 → 500
   ```

3. **不要なガウシアンをプルーニング**
   ```python
   prune_threshold = 0.01  # より積極的に
   ```

### 7.3 品質が低い

**症状**:
- PSNR、SSIMが低い
- 視覚的にぼやけている

**原因と対処**:

1. **ガウシアン数が少なすぎる**
   - 対処: 最大数を増やす、Densificationしきい値を下げる

2. **SH次数が低すぎる**
   - 対処: 次数を3に上げる（メモリ許容範囲内で）

3. **解像度が低すぎる**
   - 対処: 解像度を上げる

**バランス**: メモリと品質のトレードオフを調整

---

## 8. まとめ

### VRAM使用量の決定式（簡易版）

```
総VRAM ≈ (ガウシアン数 × 236 bytes × 倍率) + ネットワークメモリ

倍率 = 5-10（勾配、オプティマイザ状態、中間バッファ）
```

### 主要な決定要因（影響度順）

1. **ガウシアン数** ⭐⭐⭐⭐⭐ （最重要）
2. **SH係数の次数** ⭐⭐⭐⭐
3. **画像解像度** ⭐⭐⭐
4. **動的オブジェクト数**（OmniRe） ⭐⭐⭐
5. **ネットワークサイズ** ⭐ （影響小）

### 推奨GPU（再掲）

| VRAM | Deformable 3D GS | OmniRe | 備考 |
|------|------------------|--------|------|
| 8GB  | ✅ 可（制限付き） | ⚠️ 困難 | 簡単なシーンのみ |
| 12GB | ✅ 快適 | ✅ 可（中程度） | 工夫が必要 |
| 16GB | ✅ 非常に快適 | ✅ 快適 | 推奨 |
| 24GB | ✅ 完璧 | ✅ 完璧 | 論文再現可能 |

### 最終的な推奨事項

1. **最低12GB VRAMを推奨**（両手法とも）
2. **Absolute Gradient Gaussiansは必須**（特にOmniRe）
3. **適応的密度制御を適切に調整**
4. **SH次数を戦略的に調整**（重要度に応じて）
5. **メモリ使用量を定期的にモニタリング**

これらのガイドラインに従うことで、限られたVRAMリソースでも効果的にトレーニングが可能です。
